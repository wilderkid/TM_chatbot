// ==UserScript==
// @name         AI Chat Sidebar
// @namespace    http://tampermonkey.net/
// @version      1.0
// @description  AIå¯¹è¯ä¾§è¾¹æ ï¼Œæ”¯æŒå¤šAIæä¾›å•†é…ç½®
// @author       You
// @match        *://*/*
// @grant        GM_setValue
// @grant        GM_getValue
// @grant        GM_xmlhttpRequest
// @connect      *
// @require      https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js
// @require      https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/highlight.min.js
// ==/UserScript==

(function() {
    'use strict';

    // é…ç½®ç®¡ç†
    // Trusted Types ç­–ç•¥æ”¯æŒ
    let ttPolicy;
    if (window.trustedTypes && window.trustedTypes.createPolicy) {
        try {
            ttPolicy = window.trustedTypes.createPolicy('ai-chat-sidebar-policy', {
                createHTML: (string) => string
            });
        } catch (e) {
            console.warn('Failed to create Trusted Types policy:', e);
        }
    }

    const safeInnerHTML = (element, html, fallbackText) => {
        if (!element) return;
        try {
            if (ttPolicy) {
                element.innerHTML = ttPolicy.createHTML(html);
            } else {
                element.innerHTML = html;
            }
        } catch (e) {
            console.warn('innerHTML assignment failed:', e);
            element.textContent = fallbackText !== undefined ? fallbackText : html;
        }
    };

    const ConfigManager = {
        get: (key, defaultValue) => GM_getValue(key, defaultValue),
        set: (key, value) => GM_setValue(key, value),
        getProviders: () => GM_getValue('ai_providers', []),
        saveProviders: (providers) => GM_setValue('ai_providers', providers),
        getPrompts: () => GM_getValue('prompts', []),
        savePrompts: (prompts) => GM_setValue('prompts', prompts),
        getModels: (providerIndex) => GM_getValue(`models_${providerIndex}`, []),
        saveModels: (providerIndex, models) => GM_setValue(`models_${providerIndex}`, models),
        getAvailableModels: (providerIndex) => GM_getValue(`available_models_${providerIndex}`, []),
        saveAvailableModels: (providerIndex, models) => GM_setValue(`available_models_${providerIndex}`, models)
    };

    // åˆ›å»ºä¾§è¾¹æ HTML
    const createSidebar = () => {
        const sidebar = document.createElement('div');
        sidebar.id = 'ai-chat-sidebar';

        // åˆ›å»ºè°ƒæ•´å¤§å°çš„æ‰‹æŸ„
        ['left', 'right', 'top', 'bottom'].forEach(pos => {
            const handle = document.createElement('div');
            handle.className = `resize-handle-${pos}`;
            sidebar.appendChild(handle);
        });
        ['tl', 'tr', 'bl', 'br'].forEach(pos => {
            const handle = document.createElement('div');
            handle.className = `resize-handle-corner-${pos}`;
            sidebar.appendChild(handle);
        });

        // åˆ›å»ºå¤´éƒ¨
        const header = document.createElement('div');
        header.className = 'sidebar-header';

        const tabs = document.createElement('div');
        tabs.className = 'tabs';
        tabs.id = 'tabs-container';

        ['chat', 'providers', 'prompts'].forEach((tab, i) => {
            const btn = document.createElement('button');
            btn.className = i === 0 ? 'tab active' : 'tab';
            btn.dataset.tab = tab;
            btn.textContent = tab === 'chat' ? 'å¯¹è¯' : tab === 'providers' ? 'AIæä¾›å•†' : 'æç¤ºè¯åº“';
            tabs.appendChild(btn);
        });

        const closeBtn = document.createElement('button');
        closeBtn.className = 'close-btn';
        closeBtn.textContent = 'Ã—';

        header.appendChild(tabs);
        header.appendChild(closeBtn);
        sidebar.appendChild(header);

        // åˆ›å»ºå†…å®¹åŒº
        const content = document.createElement('div');
        content.className = 'sidebar-content';

        // å¯¹è¯æ ‡ç­¾é¡µ
        const chatTab = document.createElement('div');
        chatTab.className = 'tab-content active';
        chatTab.id = 'chat-tab';

        const modelSelector = document.createElement('div');
        modelSelector.className = 'model-selector';
        const modelBtn = document.createElement('button');
        modelBtn.id = 'model-display-btn';
        const modelName = document.createElement('span');
        modelName.id = 'model-name';
        modelName.textContent = 'é€‰æ‹©æ¨¡å‹';
        const arrow = document.createElement('span');
        arrow.className = 'arrow';
        arrow.textContent = 'â–¼';
        modelBtn.appendChild(modelName);
        modelBtn.appendChild(arrow);
        const modelDropdown = document.createElement('div');
        modelDropdown.id = 'model-dropdown';
        modelDropdown.className = 'model-dropdown';
        modelDropdown.style.display = 'none';
        modelSelector.appendChild(modelBtn);
        modelSelector.appendChild(modelDropdown);

        const messages = document.createElement('div');
        messages.className = 'messages';
        messages.id = 'messages';

        const inputArea = document.createElement('div');
        inputArea.className = 'input-area';
        const inputWrapper = document.createElement('div');
        inputWrapper.className = 'input-wrapper';

        const btnContainer = document.createElement('div');
        btnContainer.style.display = 'flex';
        btnContainer.style.gap = '5px';

        const promptBtn = document.createElement('button');
        promptBtn.id = 'prompt-selector-btn';
        promptBtn.className = 'prompt-icon-top';
        promptBtn.title = 'é€‰æ‹©æç¤ºè¯';
        promptBtn.textContent = 'ğŸ’¡';

        const paramsBtn = document.createElement('button');
        paramsBtn.id = 'params-selector-btn';
        paramsBtn.className = 'prompt-icon-top';
        paramsBtn.title = 'æ¨¡å‹å‚æ•°';
        paramsBtn.textContent = 'âš™ï¸';

        btnContainer.appendChild(promptBtn);
        btnContainer.appendChild(paramsBtn);

        const textarea = document.createElement('textarea');
        textarea.id = 'user-input';
        textarea.placeholder = 'è¾“å…¥æ¶ˆæ¯...';

        inputWrapper.appendChild(btnContainer);
        inputWrapper.appendChild(textarea);

        const sendBtn = document.createElement('button');
        sendBtn.id = 'send-btn';
        sendBtn.textContent = 'å‘é€';

        const promptDropdown = document.createElement('div');
        promptDropdown.id = 'prompt-dropdown';
        promptDropdown.className = 'prompt-dropdown';
        promptDropdown.style.display = 'none';

        const paramsPanel = document.createElement('div');
        paramsPanel.id = 'params-panel';
        paramsPanel.className = 'params-panel';
        paramsPanel.style.display = 'none';

        const tempItem = document.createElement('div');
        tempItem.className = 'params-item';
        const tempLabel = document.createElement('label');
        tempLabel.textContent = 'æ¸©åº¦ (Temperature):';
        const tempInput = document.createElement('input');
        tempInput.type = 'number';
        tempInput.id = 'param-temperature';
        tempInput.min = '0';
        tempInput.max = '2';
        tempInput.step = '0.1';
        tempInput.value = '0.7';
        tempItem.appendChild(tempLabel);
        tempItem.appendChild(tempInput);

        const tokensItem = document.createElement('div');
        tokensItem.className = 'params-item';
        const tokensLabel = document.createElement('label');
        tokensLabel.textContent = 'æœ€å¤§ä¸Šä¸‹æ–‡ (Max Tokens):';
        const tokensInput = document.createElement('input');
        tokensInput.type = 'number';
        tokensInput.id = 'param-max-tokens';
        tokensInput.min = '1';
        tokensInput.step = '1';
        tokensInput.value = '2048';
        tokensItem.appendChild(tokensLabel);
        tokensItem.appendChild(tokensInput);

        paramsPanel.appendChild(tempItem);
        paramsPanel.appendChild(tokensItem);

        inputArea.appendChild(inputWrapper);
        inputArea.appendChild(sendBtn);
        inputArea.appendChild(promptDropdown);
        inputArea.appendChild(paramsPanel);

        chatTab.appendChild(modelSelector);
        chatTab.appendChild(messages);
        chatTab.appendChild(inputArea);

        // æä¾›å•†æ ‡ç­¾é¡µ
        const providersTab = document.createElement('div');
        providersTab.className = 'tab-content';
        providersTab.id = 'providers-tab';
        const providersContainer = document.createElement('div');
        providersContainer.className = 'providers-container';
        const providersSidebar = document.createElement('div');
        providersSidebar.className = 'providers-sidebar';
        const addProviderBtn = document.createElement('button');
        addProviderBtn.id = 'add-provider-btn';
        addProviderBtn.textContent = '+ æ·»åŠ ä¾›åº”å•†';
        const providersList = document.createElement('div');
        providersList.className = 'providers-list';
        providersList.id = 'providers-sidebar-list';
        providersSidebar.appendChild(addProviderBtn);
        providersSidebar.appendChild(providersList);
        const providerDetail = document.createElement('div');
        providerDetail.className = 'provider-detail';
        providerDetail.id = 'provider-detail';
        const emptyState = document.createElement('div');
        emptyState.className = 'empty-state';
        emptyState.textContent = 'è¯·é€‰æ‹©æˆ–æ·»åŠ ä¸€ä¸ªä¾›åº”å•†';
        providerDetail.appendChild(emptyState);
        providersContainer.appendChild(providersSidebar);
        providersContainer.appendChild(providerDetail);
        providersTab.appendChild(providersContainer);

        // æç¤ºè¯æ ‡ç­¾é¡µ
        const promptsTab = document.createElement('div');
        promptsTab.className = 'tab-content';
        promptsTab.id = 'prompts-tab';
        const promptsToolbar = document.createElement('div');
        promptsToolbar.className = 'prompts-toolbar';
        const addPromptBtn = document.createElement('button');
        addPromptBtn.id = 'add-prompt';
        addPromptBtn.textContent = '+ æ–°å¢';
        const batchDeleteBtn = document.createElement('button');
        batchDeleteBtn.id = 'batch-delete-prompt';
        batchDeleteBtn.textContent = 'æ‰¹é‡åˆ é™¤';
        promptsToolbar.appendChild(addPromptBtn);
        promptsToolbar.appendChild(batchDeleteBtn);
        const promptsList = document.createElement('div');
        promptsList.className = 'prompts-list';
        promptsList.id = 'prompts-list';
        promptsTab.appendChild(promptsToolbar);
        promptsTab.appendChild(promptsList);

        content.appendChild(chatTab);
        content.appendChild(providersTab);
        content.appendChild(promptsTab);
        sidebar.appendChild(content);

        document.body.appendChild(sidebar);
        return sidebar;
    };

    // åˆ›å»ºè§¦å‘æŒ‰é’®
    const createTriggerButton = () => {
        const btn = document.createElement('button');
        btn.id = 'ai-chat-trigger';
        btn.textContent = 'ğŸ’¬';
        btn.title = 'AIå¯¹è¯';
        document.body.appendChild(btn);
        return btn;
    };

    // æ·»åŠ æ ·å¼
    const addStyles = () => {
        // æ·»åŠ highlight.jsæ ·å¼
        const highlightStyle = document.createElement('link');
        highlightStyle.rel = 'stylesheet';
        highlightStyle.href = 'https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/styles/github-dark.min.css';
        document.head.appendChild(highlightStyle);

        const style = document.createElement('style');
        style.textContent = `
            #ai-chat-trigger {
                position: fixed;
                right: 20px;
                bottom: 20px;
                width: 60px;
                height: 60px;
                border-radius: 50%;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                border: none;
                color: white;
                font-size: 28px;
                cursor: pointer;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 9998;
                transition: transform 0.2s;
            }
            #ai-chat-trigger:hover {
                transform: scale(1.1);
            }
            #ai-chat-sidebar {
                position: fixed;
                top: 0;
                right: 0;
                width: 400px;
                height: 100vh;
                background: white;
                box-shadow: -2px 0 8px rgba(0,0,0,0.1);
                z-index: 9999;
                display: none;
                flex-direction: column;
                border-radius: 0;
            }
            #ai-chat-sidebar.open {
                display: flex;
            }
            #ai-chat-sidebar.resizing, #ai-chat-sidebar.dragging {
                transition: none;
            }
            .resize-handle-left, .resize-handle-right {
                position: absolute;
                top: 0;
                width: 5px;
                height: 100%;
                cursor: ew-resize;
                z-index: 10;
            }
            .resize-handle-left {
                left: 0;
            }
            .resize-handle-right {
                right: 0;
            }
            .resize-handle-top, .resize-handle-bottom {
                position: absolute;
                left: 0;
                width: 100%;
                height: 5px;
                cursor: ns-resize;
                z-index: 10;
            }
            .resize-handle-top {
                top: 0;
            }
            .resize-handle-bottom {
                bottom: 0;
            }
            .resize-handle-corner-tl, .resize-handle-corner-tr,
            .resize-handle-corner-bl, .resize-handle-corner-br {
                position: absolute;
                width: 10px;
                height: 10px;
                z-index: 11;
            }
            .resize-handle-corner-tl {
                top: 0;
                left: 0;
                cursor: nwse-resize;
            }
            .resize-handle-corner-tr {
                top: 0;
                right: 0;
                cursor: nesw-resize;
            }
            .resize-handle-corner-bl {
                bottom: 0;
                left: 0;
                cursor: nesw-resize;
            }
            .resize-handle-corner-br {
                bottom: 0;
                right: 0;
                cursor: nwse-resize;
            }
            .sidebar-header {
                padding: 15px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                display: flex;
                gap: 10px;
                align-items: center;
                cursor: move;
                user-select: none;
                flex-wrap: wrap;
            }
            .tabs {
                display: flex;
                gap: 10px;
                flex-wrap: wrap;
                flex: 1;
            }
            .tab {
                background: rgba(255,255,255,0.2);
                border: none;
                color: white;
                padding: 8px 16px;
                border-radius: 4px;
                cursor: pointer;
                transition: background 0.2s;
            }
            .tab:hover, .tab.active {
                background: rgba(255,255,255,0.3);
            }
            .close-btn {
                background: none;
                border: none;
                color: white;
                font-size: 28px;
                cursor: pointer;
                line-height: 1;
                margin-left: auto;
            }
            .sidebar-content {
                flex: 1;
                overflow: hidden;
                display: flex;
                flex-direction: column;
            }
            .tab-content {
                display: none;
                flex: 1;
                flex-direction: column;
                overflow: hidden;
            }
            .tab-content.active {
                display: flex;
            }
            .messages {
                flex: 1;
                overflow-y: auto;
                padding: 15px;
                display: flex;
                flex-direction: column;
            }
            .message {
                margin-bottom: 15px;
                padding: 10px;
                border-radius: 8px;
                max-width: 80%;
                width: fit-content;
                text-align: left;
            }
            .message.user {
                background: #667eea;
                color: white;
                align-self: flex-end;
            }
            .message.ai {
                background: #f0f0f0;
                align-self: flex-start;
            }
            #ai-chat-sidebar .message pre {
                background: #282c34;
                padding: 12px;
                border-radius: 6px;
                overflow-x: auto;
                margin: 8px 0;
            }
            #ai-chat-sidebar .message code {
                font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
                font-size: 13px;
            }
            #ai-chat-sidebar .message pre code {
                background: none;
                padding: 0;
            }
            #ai-chat-sidebar .message :not(pre) > code {
                background: rgba(0,0,0,0.1);
                padding: 2px 6px;
                border-radius: 3px;
            }
            #ai-chat-sidebar .message p {
                margin: 8px 0;
            }
            #ai-chat-sidebar .message p:first-child {
                margin-top: 0;
            }
            #ai-chat-sidebar .message p:last-child {
                margin-bottom: 0;
            }
            #ai-chat-sidebar .message ul, #ai-chat-sidebar .message ol {
                margin: 8px 0;
                padding-left: 24px;
            }
            #ai-chat-sidebar .message blockquote {
                border-left: 3px solid #667eea;
                padding-left: 12px;
                margin: 8px 0;
                color: #666;
            }
            #ai-chat-sidebar .message table {
                border-collapse: collapse;
                margin: 8px 0;
                width: 100%;
            }
            #ai-chat-sidebar .message th, #ai-chat-sidebar .message td {
                border: 1px solid #ddd;
                padding: 8px;
                text-align: left;
            }
            #ai-chat-sidebar .message th {
                background: #f5f5f5;
                font-weight: bold;
            }
            .model-selector {
                padding: 10px 15px;
                border-bottom: 1px solid #eee;
                position: relative;
            }
            #model-display-btn {
                background: none;
                border: none;
                color: #667eea;
                font-size: 14px;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 5px;
                padding: 5px 0;
                font-weight: 500;
            }
            #model-display-btn:hover {
                opacity: 0.8;
            }
            #model-display-btn .arrow {
                font-size: 10px;
                transition: transform 0.2s;
            }
            #model-display-btn.open .arrow {
                transform: rotate(180deg);
            }
            .model-dropdown {
                position: absolute;
                top: 100%;
                left: 15px;
                right: 15px;
                background: white;
                border: 1px solid #ddd;
                border-radius: 4px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                max-height: 200px;
                overflow-y: auto;
                z-index: 100;
            }
            .model-dropdown-item {
                padding: 10px 15px;
                cursor: pointer;
                border-bottom: 1px solid #f0f0f0;
            }
            .model-dropdown-item:last-child {
                border-bottom: none;
            }
            .model-dropdown-item:hover {
                background: #f5f5f5;
            }
            .model-dropdown-item.selected {
                background: #667eea;
                color: white;
            }
            .input-area {
                padding: 15px;
                border-top: 1px solid #eee;
                position: relative;
            }
            .input-wrapper {
                position: relative;
                border: 1px solid #ddd;
                border-radius: 4px;
                background: white;
                padding: 10px;
                display: flex;
                flex-direction: column;
                gap: 8px;
                resize: vertical;
                overflow: hidden;
                min-height: 70px;
            }
            .prompt-icon-top {
                background: none;
                border: none;
                font-size: 18px;
                cursor: pointer;
                padding: 4px;
                align-self: flex-start;
                line-height: 1;
                border-radius: 4px;
                transition: background 0.2s;
                flex-shrink: 0;
            }
            .prompt-icon-top:hover {
                background: rgba(102, 126, 234, 0.1);
            }
            .prompt-icon-top.selected {
                background: rgba(102, 126, 234, 0.2);
            }
            #user-input {
                flex: 1;
                border: none;
                outline: none;
                resize: none;
                font-family: inherit;
                min-height: 40px;
                padding: 0;
                overflow-y: auto;
            }
            #send-btn {
                margin-top: 10px;
            }
            .prompt-dropdown {
                position: absolute;
                bottom: 100%;
                left: 0;
                right: 0;
                background: white;
                border: 1px solid #ddd;
                border-radius: 4px;
                box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
                max-height: 300px;
                overflow-y: auto;
                z-index: 100;
                margin-bottom: 8px;
            }
            .prompt-dropdown-item {
                padding: 10px 15px;
                cursor: pointer;
                border-bottom: 1px solid #f0f0f0;
            }
            .prompt-dropdown-item:last-child {
                border-bottom: none;
            }
            .prompt-dropdown-item:hover {
                background: #f5f5f5;
            }
            .prompt-dropdown-item .prompt-title {
                font-weight: 500;
                margin-bottom: 4px;
            }
            .prompt-dropdown-item .prompt-preview {
                font-size: 12px;
                color: #999;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            .params-panel {
                position: absolute;
                bottom: 100%;
                left: 0;
                right: 0;
                background: white;
                border: 1px solid #ddd;
                border-radius: 4px;
                box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
                padding: 15px;
                z-index: 100;
                margin-bottom: 8px;
            }
            .params-item {
                margin-bottom: 10px;
            }
            .params-item:last-child {
                margin-bottom: 0;
            }
            .params-item label {
                display: block;
                margin-bottom: 5px;
                font-size: 12px;
                font-weight: 500;
                color: #333;
            }
            .params-item input {
                width: 100%;
                padding: 6px;
                border: 1px solid #ddd;
                border-radius: 4px;
                font-size: 13px;
            }
            #send-btn {
                padding: 10px 20px;
                background: #667eea;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
            }
            #send-btn:hover {
                background: #5568d3;
            }
            .providers-container {
                display: flex;
                height: 100%;
            }
            .providers-sidebar {
                width: 200px;
                border-right: 1px solid #eee;
                display: flex;
                flex-direction: column;
            }
            #add-provider-btn {
                margin: 15px;
                padding: 10px;
                background: #667eea;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
            }
            .providers-list {
                flex: 1;
                overflow-y: auto;
            }
            .provider-sidebar-item {
                padding: 12px 15px;
                cursor: pointer;
                border-bottom: 1px solid #eee;
                transition: background 0.2s;
                display: flex;
                align-items: center;
                justify-content: space-between;
            }
            .provider-sidebar-item:hover {
                background: #f5f5f5;
            }
            .provider-sidebar-item.active {
                background: #667eea;
                color: white;
            }
            .provider-sidebar-item .delete-icon {
                opacity: 0;
                cursor: pointer;
                font-size: 16px;
                padding: 2px 6px;
                border-radius: 3px;
                transition: opacity 0.2s;
            }
            .provider-sidebar-item:hover .delete-icon {
                opacity: 1;
            }
            .provider-sidebar-item .delete-icon:hover {
                background: rgba(231, 76, 60, 0.2);
            }
            .provider-sidebar-item.active .delete-icon:hover {
                background: rgba(255, 255, 255, 0.3);
            }
            .provider-detail {
                flex: 1;
                overflow-y: auto;
                padding: 20px;
            }
            .empty-state {
                text-align: center;
                color: #999;
                padding: 50px 20px;
            }
            .provider-form {
                max-width: 600px;
            }
            .provider-form h3 {
                margin: 0 0 20px 0;
            }
            .form-group {
                margin-bottom: 15px;
                display: flex;
                align-items: center;
                gap: 15px;
            }
            .form-group label {
                min-width: 100px;
                font-weight: bold;
            }
            .form-group input {
                flex: 1;
                padding: 8px;
                border: 1px solid #ddd;
                border-radius: 4px;
            }
            .final-url-display {
                margin-left: 115px;
                padding: 8px;
                background: #f0f0f0;
                border-radius: 4px;
                font-size: 12px;
                color: #666;
                word-break: break-all;
            }
            .final-url-display strong {
                color: #333;
            }
            .form-group.password-group {
                position: relative;
            }
            .form-group.password-group input {
                padding-right: 40px;
            }
            .form-group .toggle-password {
                position: absolute;
                right: 10px;
                cursor: pointer;
                font-size: 18px;
                user-select: none;
            }
            .form-actions {
                display: flex;
                gap: 10px;
                margin-top: 20px;
                margin-left: 115px;
            }
            .form-actions button {
                padding: 10px 20px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                color: white;
            }
            .save-provider-btn {
                background: #667eea;
            }
            .models-section {
                margin-top: 30px;
                padding-top: 20px;
                border-top: 2px solid #eee;
            }
            .models-section h3 {
                margin: 0 0 15px 0;
                display: flex;
                align-items: center;
                gap: 10px;
            }
            .fetch-models-btn, .refresh-models-btn {
                padding: 6px 12px;
                background: #3498db;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 12px;
            }
            .refresh-models-btn {
                background: #2ecc71;
            }
            .available-models-section {
                margin-top: 20px;
                padding: 15px;
                background: #f9f9f9;
                border-radius: 8px;
            }
            .available-models-section h4 {
                margin: 0 0 10px 0;
                font-size: 14px;
            }
            .model-search {
                width: 100%;
                padding: 8px;
                margin-bottom: 10px;
                border: 1px solid #ddd;
                border-radius: 4px;
            }
            .available-models-list {
                max-height: 300px;
                overflow-y: auto;
                display: flex;
                flex-direction: column;
                gap: 5px;
            }
            .available-model-item {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 8px;
                background: white;
                border-radius: 4px;
                border: 1px solid #eee;
            }
            .available-model-item .model-name {
                flex: 1;
                font-size: 13px;
            }
            .available-model-item .add-model-icon {
                cursor: pointer;
                color: #667eea;
                font-size: 18px;
                padding: 2px 6px;
                border-radius: 3px;
                transition: background 0.2s;
            }
            .available-model-item .add-model-icon:hover {
                background: rgba(102, 126, 234, 0.1);
            }
            .loading-models {
                text-align: center;
                padding: 20px;
                color: #999;
            }
            .models-list {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }
            .model-item {
                background: #f9f9f9;
                padding: 10px;
                border-radius: 4px;
                display: flex;
                align-items: center;
                gap: 10px;
            }
            .model-item input {
                flex: 1;
                padding: 8px;
                border: 1px solid #ddd;
                border-radius: 4px;
            }
            .model-item button {
                padding: 6px 12px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 12px;
                color: white;
            }
            .save-model-btn {
                background: #667eea;
            }
            .delete-model-btn {
                background: #e74c3c;
            }
            .add-model-btn {
                margin-top: 10px;
                padding: 8px 16px;
                background: #667eea;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
            }
            .prompts-toolbar {
                padding: 15px;
                display: flex;
                gap: 10px;
                border-bottom: 1px solid #eee;
            }
            .prompts-toolbar button {
                padding: 8px 16px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                color: white;
            }
            #add-prompt {
                background: #667eea;
            }
            #batch-delete-prompt {
                background: #e74c3c;
            }
            .prompts-list {
                flex: 1;
                overflow-y: auto;
                padding: 15px;
            }
            .prompt-item {
                background: #f9f9f9;
                padding: 15px;
                margin-bottom: 10px;
                border-radius: 8px;
                position: relative;
            }
            .prompt-item.editing {
                background: #fff;
                border: 2px solid #667eea;
            }
            .prompt-item input[type="checkbox"] {
                position: absolute;
                top: 15px;
                left: 15px;
                width: 18px;
                height: 18px;
                cursor: pointer;
            }
            .prompt-item .prompt-header {
                display: flex;
                align-items: center;
                gap: 10px;
                margin-bottom: 10px;
                padding-left: 30px;
            }
            .prompt-item .prompt-title {
                flex: 1;
                font-weight: bold;
                font-size: 16px;
            }
            .prompt-item .prompt-actions {
                display: flex;
                gap: 5px;
            }
            .prompt-item .prompt-actions button {
                padding: 4px 10px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 12px;
            }
            .prompt-item .view-btn {
                background: #3498db;
                color: white;
            }
            .prompt-item .edit-btn {
                background: #f39c12;
                color: white;
            }
            .prompt-item .delete-btn {
                background: #e74c3c;
                color: white;
            }
            .prompt-item .prompt-content {
                padding-left: 30px;
                color: #666;
                white-space: pre-wrap;
                word-break: break-word;
            }
            .prompt-item .prompt-form {
                padding-left: 30px;
            }
            .prompt-item .prompt-form input,
            .prompt-item .prompt-form textarea {
                width: 100%;
                padding: 8px;
                margin: 5px 0;
                border: 1px solid #ddd;
                border-radius: 4px;
                font-family: inherit;
            }
            .prompt-item .prompt-form textarea {
                min-height: 100px;
                resize: vertical;
            }
            .prompt-item .prompt-form .form-actions {
                margin-top: 10px;
                display: flex;
                gap: 10px;
            }
            .prompt-item .prompt-form .form-actions button {
                padding: 6px 16px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                color: white;
            }
            .prompt-item .save-prompt-btn {
                background: #667eea;
            }
            .prompt-item .cancel-btn {
                background: #95a5a6;
            }
        `;
        document.head.appendChild(style);
    };

    // åˆå§‹åŒ–
    const init = () => {
        addStyles();
        const triggerBtn = createTriggerButton();
        const sidebar = createSidebar();

        // åˆ‡æ¢ä¾§è¾¹æ 
        triggerBtn.addEventListener('click', () => {
            sidebar.classList.toggle('open');
        });

        sidebar.querySelector('.close-btn').addEventListener('click', () => {
            sidebar.classList.remove('open');
        });

        // æ‹–æ‹½è°ƒæ•´å¤§å°
        let isResizing = false;
        let resizeType = '';
        let startX = 0;
        let startY = 0;
        let startWidth = 0;
        let startHeight = 0;
        let startLeft = 0;
        let startTop = 0;

        const startResize = (e, type) => {
            isResizing = true;
            resizeType = type;
            startX = e.clientX;
            startY = e.clientY;
            const rect = sidebar.getBoundingClientRect();
            startWidth = rect.width;
            startHeight = rect.height;
            startLeft = rect.left;
            startTop = rect.top;
            sidebar.classList.add('resizing');
            e.preventDefault();
            e.stopPropagation();
        };

        sidebar.querySelector('.resize-handle-left').addEventListener('mousedown', (e) => startResize(e, 'left'));
        sidebar.querySelector('.resize-handle-right').addEventListener('mousedown', (e) => startResize(e, 'right'));
        sidebar.querySelector('.resize-handle-top').addEventListener('mousedown', (e) => startResize(e, 'top'));
        sidebar.querySelector('.resize-handle-bottom').addEventListener('mousedown', (e) => startResize(e, 'bottom'));
        sidebar.querySelector('.resize-handle-corner-tl').addEventListener('mousedown', (e) => startResize(e, 'top-left'));
        sidebar.querySelector('.resize-handle-corner-tr').addEventListener('mousedown', (e) => startResize(e, 'top-right'));
        sidebar.querySelector('.resize-handle-corner-bl').addEventListener('mousedown', (e) => startResize(e, 'bottom-left'));
        sidebar.querySelector('.resize-handle-corner-br').addEventListener('mousedown', (e) => startResize(e, 'bottom-right'));

        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;

            const deltaX = e.clientX - startX;
            const deltaY = e.clientY - startY;

            if (resizeType.includes('left')) {
                const newWidth = startWidth - deltaX;
                if (newWidth >= 200) {
                    sidebar.style.width = newWidth + 'px';
                }
            }
            if (resizeType.includes('right')) {
                const newWidth = startWidth + deltaX;
                if (newWidth >= 200) {
                    sidebar.style.width = newWidth + 'px';
                }
            }
            if (resizeType.includes('top')) {
                const newHeight = startHeight - deltaY;
                if (newHeight >= 200) {
                    sidebar.style.height = newHeight + 'px';
                    sidebar.style.top = (startTop + deltaY) + 'px';
                }
            }
            if (resizeType.includes('bottom')) {
                const newHeight = startHeight + deltaY;
                if (newHeight >= 200) {
                    sidebar.style.height = newHeight + 'px';
                }
            }
        });

        document.addEventListener('mouseup', () => {
            if (isResizing) {
                isResizing = false;
                resizeType = '';
                sidebar.classList.remove('resizing');
            }
        });

        // æ‹–æ‹½ç§»åŠ¨çª—å£
        const header = sidebar.querySelector('.sidebar-header');
        let isDragging = false;
        let dragStartX = 0;
        let dragStartY = 0;
        let sidebarLeft = 0;
        let sidebarTop = 0;

        header.addEventListener('mousedown', (e) => {
            // å¦‚æœç‚¹å‡»çš„æ˜¯æŒ‰é’®ï¼Œä¸è§¦å‘æ‹–åŠ¨
            if (e.target.tagName === 'BUTTON') return;
            isDragging = true;
            dragStartX = e.clientX;
            dragStartY = e.clientY;
            const rect = sidebar.getBoundingClientRect();
            sidebarLeft = rect.left;
            sidebarTop = rect.top;
            sidebar.classList.add('dragging');
            e.preventDefault();
        });

        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            const deltaX = e.clientX - dragStartX;
            const deltaY = e.clientY - dragStartY;
            const newLeft = sidebarLeft + deltaX;
            const newTop = sidebarTop + deltaY;
            sidebar.style.left = newLeft + 'px';
            sidebar.style.top = newTop + 'px';
        });

        document.addEventListener('mouseup', () => {
            if (isDragging) {
                isDragging = false;
                sidebar.classList.remove('dragging');
            }
        });

        // é€‰é¡¹å¡åˆ‡æ¢
        sidebar.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;
                sidebar.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                sidebar.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                sidebar.querySelector(`#${tabName}-tab`).classList.add('active');
            });
        });

        // AIæä¾›å•†ç®¡ç†
        let currentProviderIndex = null;

        const renderProvidersSidebar = () => {
            const providers = ConfigManager.getProviders();
            const list = sidebar.querySelector('#providers-sidebar-list');
            list.textContent = '';

            providers.forEach((provider, index) => {
                const item = document.createElement('div');
                item.className = 'provider-sidebar-item';
                if (index === currentProviderIndex) {
                    item.classList.add('active');
                }
                safeInnerHTML(item, `
                    <span class="provider-name">${provider.name || 'æœªå‘½åä¾›åº”å•†'}</span>
                    <span class="delete-icon" data-index="${index}">Ã—</span>
                `);
                item.dataset.index = index;
                list.appendChild(item);
            });

            updateModelSelect();
        };

        const normalizeApiUrl = (url) => {
            if (!url) return '';
            url = url.trim();

            // å¦‚æœå·²ç»åŒ…å« /chat/completionsï¼Œç›´æ¥è¿”å›
            if (url.includes('/chat/completions')) {
                return url;
            }

            // ç§»é™¤æœ«å°¾çš„æ–œæ 
            url = url.replace(/\/+$/, '');

            // å¦‚æœåŒ…å«ç‰ˆæœ¬å·ï¼ˆv1, v2, v3ç­‰ï¼‰ï¼Œåœ¨å…¶åæ·»åŠ  /chat/completions
            if (/\/v\d+$/i.test(url)) {
                return url + '/chat/completions';
            }

            // é»˜è®¤æ·»åŠ  /v1/chat/completions
            return url + '/v1/chat/completions';
        };

        const getModelsUrl = (url) => {
            if (!url) return '';
            url = url.trim();

            // å¦‚æœå·²ç»åŒ…å« /modelsï¼Œç›´æ¥è¿”å›
            if (url.includes('/models')) {
                return url;
            }

            // ç§»é™¤æœ«å°¾çš„æ–œæ 
            url = url.replace(/\/+$/, '');

            // å¦‚æœåŒ…å«ç‰ˆæœ¬å·ï¼ˆv1, v2, v3ç­‰ï¼‰ï¼Œåœ¨å…¶åæ·»åŠ  /models
            if (/\/v\d+$/i.test(url)) {
                return url + '/models';
            }

            // é»˜è®¤æ·»åŠ  /v1/models
            return url + '/v1/models';
        };

        const updateFinalUrl = (index) => {
            const urlInput = sidebar.querySelector(`#provider-url-${index}`);
            const finalUrlDisplay = sidebar.querySelector(`#final-url-${index}`);
            if (urlInput && finalUrlDisplay) {
                const finalUrl = normalizeApiUrl(urlInput.value);
                safeInnerHTML(finalUrlDisplay, `<strong>æœ€ç»ˆè°ƒç”¨åœ°å€ï¼š</strong>${finalUrl || 'è¯·è¾“å…¥API URL'}`);
            }
        };

        const renderProviderDetail = (index) => {
            const providers = ConfigManager.getProviders();
            const provider = providers[index];
            const detail = sidebar.querySelector('#provider-detail');
            const models = ConfigManager.getModels(index);

            safeInnerHTML(detail, `
                <div class="provider-form">
                    <h3>ä¾›åº”å•†ä¿¡æ¯</h3>
                    <div class="form-group">
                        <label>ä¾›åº”å•†åç§°</label>
                        <input type="text" value="${provider.name || ''}" id="provider-name-${index}">
                    </div>
                    <div class="form-group">
                        <label>API URL</label>
                        <input type="text" value="${provider.url || ''}" id="provider-url-${index}" placeholder="ä¾‹å¦‚: https://api.openai.com">
                    </div>
                    <div class="final-url-display" id="final-url-${index}"></div>
                    <div class="form-group password-group">
                        <label>API Key</label>
                        <input type="password" value="${provider.key || ''}" id="provider-key-${index}">
                        <span class="toggle-password" data-target="provider-key-${index}">ğŸ‘ï¸</span>
                    </div>
                    <div class="form-actions">
                        <button class="save-provider-btn" data-index="${index}">ä¿å­˜</button>
                    </div>

                    <div class="models-section">
                        <h3>
                            å·²æ·»åŠ æ¨¡å‹
                            <button class="fetch-models-btn" data-index="${index}">è·å–æ¨¡å‹åˆ—è¡¨</button>
                            <button class="refresh-models-btn" data-index="${index}" style="display:none;">åˆ·æ–°</button>
                        </h3>
                        <div class="models-list" id="models-list-${index}"></div>
                        <button class="add-model-btn" data-index="${index}">+ æ‰‹åŠ¨æ·»åŠ æ¨¡å‹</button>

                        <div class="available-models-section" id="available-models-${index}" style="display:none;">
                            <h4>å¯ç”¨æ¨¡å‹åˆ—è¡¨</h4>
                            <input type="text" class="model-search" placeholder="æœç´¢æ¨¡å‹..." id="model-search-${index}">
                            <div class="available-models-list" id="available-models-list-${index}"></div>
                        </div>
                    </div>
                </div>
            `);

            const modelsList = detail.querySelector(`#models-list-${index}`);
            models.forEach((model, modelIndex) => {
                const item = document.createElement('div');
                item.className = 'model-item';
                safeInnerHTML(item, `
                    <input type="text" value="${model}" data-model="${modelIndex}">
                    <button class="save-model-btn" data-provider="${index}" data-model="${modelIndex}">ä¿å­˜</button>
                    <button class="delete-model-btn" data-provider="${index}" data-model="${modelIndex}">åˆ é™¤</button>
                `);
                modelsList.appendChild(item);
            });

            // åˆå§‹åŒ–æ˜¾ç¤ºæœ€ç»ˆURL
            updateFinalUrl(index);

            // ç›‘å¬URLè¾“å…¥æ¡†å˜åŒ–
            const urlInput = sidebar.querySelector(`#provider-url-${index}`);
            if (urlInput) {
                urlInput.addEventListener('input', () => updateFinalUrl(index));
            }

            // ç›‘å¬æ¨¡å‹æœç´¢
            const searchInput = detail.querySelector(`#model-search-${index}`);
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    filterAvailableModels(index, e.target.value);
                });
            }

            // åŠ è½½å·²ä¿å­˜çš„å¯ç”¨æ¨¡å‹åˆ—è¡¨
            loadAvailableModels(index);
        };

        const fetchAvailableModels = async (index) => {
            const providers = ConfigManager.getProviders();
            const provider = providers[index];

            if (!provider.url || !provider.key) {
                alert('è¯·å…ˆé…ç½®API URLå’ŒAPI Key');
                return;
            }

            const availableSection = sidebar.querySelector(`#available-models-${index}`);
            const availableList = sidebar.querySelector(`#available-models-list-${index}`);
            const fetchBtn = sidebar.querySelector(`.fetch-models-btn[data-index="${index}"]`);
            const refreshBtn = sidebar.querySelector(`.refresh-models-btn[data-index="${index}"]`);

            safeInnerHTML(availableList, '<div class="loading-models">æ­£åœ¨è·å–æ¨¡å‹åˆ—è¡¨...</div>');
            availableSection.style.display = 'block';

            const modelsUrl = getModelsUrl(provider.url);

            GM_xmlhttpRequest({
                method: 'GET',
                url: modelsUrl,
                headers: {
                    'Authorization': `Bearer ${provider.key}`
                },
                onload: (response) => {
                    try {
                        const data = JSON.parse(response.responseText);
                        const models = data.data || data.models || [];
                        const modelNames = models.map(m => m.id || m.name || m).filter(Boolean);

                        ConfigManager.saveAvailableModels(index, modelNames);
                        renderAvailableModels(index, modelNames);

                        fetchBtn.style.display = 'none';
                        refreshBtn.style.display = 'inline-block';
                    } catch (e) {
                        safeInnerHTML(availableList, '<div class="loading-models">è·å–å¤±è´¥: ' + e.message + '</div>');
                    }
                },
                onerror: () => {
                    safeInnerHTML(availableList, '<div class="loading-models">è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥URLå’ŒAPI Key</div>');
                }
            });
        };

        const renderAvailableModels = (index, models) => {
            const availableList = sidebar.querySelector(`#available-models-list-${index}`);
            const existingModels = ConfigManager.getModels(index);

            availableList.textContent = '';
            models.forEach(modelName => {
                const item = document.createElement('div');
                item.className = 'available-model-item';
                item.dataset.modelName = modelName;
                safeInnerHTML(item, `
                    <span class="model-name">${modelName}</span>
                    <span class="add-model-icon" data-provider="${index}" data-model-name="${modelName}">+</span>
                `);
                availableList.appendChild(item);
            });
        };

        const filterAvailableModels = (index, keyword) => {
            const models = ConfigManager.getAvailableModels(index);
            const filtered = keyword ? models.filter(m => m.toLowerCase().includes(keyword.toLowerCase())) : models;
            renderAvailableModels(index, filtered);
        };

        const updateModelSelect = () => {
            // ä¿æŒå…¼å®¹æ€§ï¼Œä½†ä¸å†ä½¿ç”¨
        };

        sidebar.querySelector('#add-provider-btn').addEventListener('click', () => {
            const providers = ConfigManager.getProviders();
            providers.push({name: 'æ–°ä¾›åº”å•†', url: '', key: ''});
            ConfigManager.saveProviders(providers);
            currentProviderIndex = providers.length - 1;
            renderProvidersSidebar();
            renderProviderDetail(currentProviderIndex);
        });

        sidebar.querySelector('#providers-sidebar-list').addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-icon')) {
                e.stopPropagation();
                const index = parseInt(e.target.dataset.index);
                if (!confirm('ç¡®å®šåˆ é™¤æ­¤ä¾›åº”å•†å—ï¼Ÿ')) return;

                const providers = ConfigManager.getProviders();
                providers.splice(index, 1);
                ConfigManager.saveProviders(providers);

                if (currentProviderIndex === index) {
                    currentProviderIndex = null;
                    safeInnerHTML(sidebar.querySelector('#provider-detail'), '<div class="empty-state">è¯·é€‰æ‹©æˆ–æ·»åŠ ä¸€ä¸ªä¾›åº”å•†</div>');
                } else if (currentProviderIndex > index) {
                    currentProviderIndex--;
                }
                renderProvidersSidebar();
                updateModelSelect();
                return;
            }

            const item = e.target.closest('.provider-sidebar-item');
            if (!item) return;

            currentProviderIndex = parseInt(item.dataset.index);
            renderProvidersSidebar();
            renderProviderDetail(currentProviderIndex);
        });

        sidebar.querySelector('#provider-detail').addEventListener('click', (e) => {
            if (e.target.classList.contains('toggle-password')) {
                const targetId = e.target.dataset.target;
                const input = sidebar.querySelector(`#${targetId}`);
                if (input.type === 'password') {
                    input.type = 'text';
                    e.target.textContent = 'ğŸ™ˆ';
                } else {
                    input.type = 'password';
                    e.target.textContent = 'ğŸ‘ï¸';
                }
            } else if (e.target.classList.contains('save-provider-btn')) {
                const index = parseInt(e.target.dataset.index);
                const providers = ConfigManager.getProviders();

                providers[index] = {
                    name: sidebar.querySelector(`#provider-name-${index}`).value,
                    url: sidebar.querySelector(`#provider-url-${index}`).value,
                    key: sidebar.querySelector(`#provider-key-${index}`).value
                };

                ConfigManager.saveProviders(providers);
                renderProvidersSidebar();
                updateModelSelect();
                alert('ä¿å­˜æˆåŠŸ');
            } else if (e.target.classList.contains('fetch-models-btn')) {
                const providerIndex = parseInt(e.target.dataset.index);
                fetchAvailableModels(providerIndex);
            } else if (e.target.classList.contains('refresh-models-btn')) {
                const providerIndex = parseInt(e.target.dataset.index);
                fetchAvailableModels(providerIndex);
            } else if (e.target.classList.contains('add-model-icon')) {
                const providerIndex = parseInt(e.target.dataset.provider);
                const modelName = e.target.dataset.modelName;
                const models = ConfigManager.getModels(providerIndex);

                if (!models.includes(modelName)) {
                    models.push(modelName);
                    ConfigManager.saveModels(providerIndex, models);
                    renderProviderDetail(providerIndex);
                    updateModelSelect();

                    // æ¢å¤å¯ç”¨æ¨¡å‹åˆ—è¡¨æ˜¾ç¤º
                    const availableSection = sidebar.querySelector(`#available-models-${providerIndex}`);
                    if (availableSection) {
                        availableSection.style.display = 'block';
                        const searchInput = sidebar.querySelector(`#model-search-${providerIndex}`);
                        if (searchInput) {
                            filterAvailableModels(providerIndex, searchInput.value);
                        }
                    }
                } else {
                    alert('è¯¥æ¨¡å‹å·²å­˜åœ¨');
                }
            } else if (e.target.classList.contains('add-model-btn')) {
                const providerIndex = parseInt(e.target.dataset.index);
                const models = ConfigManager.getModels(providerIndex);
                models.push('');
                ConfigManager.saveModels(providerIndex, models);
                renderProviderDetail(providerIndex);
            } else if (e.target.classList.contains('save-model-btn')) {
                const providerIndex = parseInt(e.target.dataset.provider);
                const modelIndex = parseInt(e.target.dataset.model);
                const input = e.target.closest('.model-item').querySelector('input');
                const models = ConfigManager.getModels(providerIndex);
                models[modelIndex] = input.value.trim();
                ConfigManager.saveModels(providerIndex, models);
                updateModelSelect();
                alert('æ¨¡å‹ä¿å­˜æˆåŠŸ');
            } else if (e.target.classList.contains('delete-model-btn')) {
                const providerIndex = parseInt(e.target.dataset.provider);
                const modelIndex = parseInt(e.target.dataset.model);
                if (!confirm('ç¡®å®šåˆ é™¤æ­¤æ¨¡å‹å—ï¼Ÿ')) return;

                const models = ConfigManager.getModels(providerIndex);
                models.splice(modelIndex, 1);
                ConfigManager.saveModels(providerIndex, models);
                renderProviderDetail(providerIndex);
                updateModelSelect();
            }
        });

        renderProvidersSidebar();

        // æ¨¡å‹é€‰æ‹©ä¸‹æ‹‰èœå•
        let currentSelectedModel = null;
        const modelDisplayBtn = sidebar.querySelector('#model-display-btn');
        const modelDropdown = sidebar.querySelector('#model-dropdown');
        const modelNameSpan = sidebar.querySelector('#model-name');

        const renderModelDropdown = () => {
            const providers = ConfigManager.getProviders();
            modelDropdown.textContent = '';

            providers.forEach((provider, providerIndex) => {
                const models = ConfigManager.getModels(providerIndex);
                models.forEach(model => {
                    const item = document.createElement('div');
                    item.className = 'model-dropdown-item';
                    const modelValue = JSON.stringify({provider: providerIndex, model: model});
                    if (currentSelectedModel === modelValue) {
                        item.classList.add('selected');
                    }
                    item.textContent = `${provider.name} - ${model}`;
                    item.dataset.value = modelValue;
                    modelDropdown.appendChild(item);
                });
            });
        };

        modelDisplayBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            const isOpen = modelDropdown.style.display === 'block';
            modelDropdown.style.display = isOpen ? 'none' : 'block';
            modelDisplayBtn.classList.toggle('open', !isOpen);
            if (!isOpen) renderModelDropdown();
        });

        modelDropdown.addEventListener('click', (e) => {
            const item = e.target.closest('.model-dropdown-item');
            if (!item) return;

            currentSelectedModel = item.dataset.value;
            const config = JSON.parse(currentSelectedModel);
            const providers = ConfigManager.getProviders();
            const provider = providers[config.provider];
            modelNameSpan.textContent = `${provider.name} - ${config.model}`;
            modelDropdown.style.display = 'none';
            modelDisplayBtn.classList.remove('open');
        });

        document.addEventListener('click', () => {
            modelDropdown.style.display = 'none';
            modelDisplayBtn.classList.remove('open');
        });

        // æç¤ºè¯é€‰æ‹©ä¸‹æ‹‰èœå•
        let currentSystemPrompt = '';
        const promptSelectorBtn = sidebar.querySelector('#prompt-selector-btn');
        const promptDropdown = sidebar.querySelector('#prompt-dropdown');

        const renderPromptDropdown = () => {
            const prompts = ConfigManager.getPrompts();
            promptDropdown.textContent = '';

            if (prompts.length === 0) {
                safeInnerHTML(promptDropdown, '<div class="prompt-dropdown-item" style="text-align:center;color:#999;">æš‚æ— æç¤ºè¯</div>');
                return;
            }

            prompts.forEach((prompt, index) => {
                const item = document.createElement('div');
                item.className = 'prompt-dropdown-item';
                safeInnerHTML(item, `
                    <div class="prompt-title">${prompt.title || 'æœªå‘½å'}</div>
                    <div class="prompt-preview">${prompt.content || ''}</div>
                `);
                item.dataset.index = index;
                promptDropdown.appendChild(item);
            });
        };

        promptSelectorBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            const isOpen = promptDropdown.style.display === 'block';
            promptDropdown.style.display = isOpen ? 'none' : 'block';
            sidebar.querySelector('#params-panel').style.display = 'none';
            sidebar.querySelector('#params-selector-btn').classList.remove('selected');
            if (!isOpen) renderPromptDropdown();
        });

        // æ¨¡å‹å‚æ•°è®¾ç½®
        let modelParams = {temperature: 0.7, max_tokens: 2048};
        const paramsSelectorBtn = sidebar.querySelector('#params-selector-btn');
        const paramsPanel = sidebar.querySelector('#params-panel');
        const tempInput = sidebar.querySelector('#param-temperature');
        const maxTokensInput = sidebar.querySelector('#param-max-tokens');

        paramsSelectorBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            const isOpen = paramsPanel.style.display === 'block';
            paramsPanel.style.display = isOpen ? 'none' : 'block';
            promptDropdown.style.display = 'none';
            paramsSelectorBtn.classList.toggle('selected', !isOpen);
        });

        tempInput.addEventListener('input', (e) => {
            modelParams.temperature = parseFloat(e.target.value) || 0.7;
        });

        maxTokensInput.addEventListener('input', (e) => {
            modelParams.max_tokens = parseInt(e.target.value) || 2048;
        });

        promptDropdown.addEventListener('click', (e) => {
            const item = e.target.closest('.prompt-dropdown-item');
            if (!item || !item.dataset.index) return;

            const prompts = ConfigManager.getPrompts();
            const prompt = prompts[parseInt(item.dataset.index)];
            currentSystemPrompt = prompt.content;
            promptDropdown.style.display = 'none';
            promptSelectorBtn.classList.add('selected');
            promptSelectorBtn.title = `å·²é€‰æ‹©: ${prompt.title}`;
        });

        // åˆå§‹åŒ–åŠ è½½æ¨¡å‹å’Œæç¤ºè¯
        renderModelDropdown();
        renderPromptDropdown();

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.input-area')) {
                promptDropdown.style.display = 'none';
                paramsPanel.style.display = 'none';
                paramsSelectorBtn.classList.remove('selected');
            }
        });

        // å¯¹è¯åŠŸèƒ½
        const sendMessage = async () => {
            const input = sidebar.querySelector('#user-input');
            const messages = sidebar.querySelector('#messages');
            const select = sidebar.querySelector('#model-select');
            const text = input.value.trim();

            if (!text) return;
            if (!currentSelectedModel) {
                alert('è¯·å…ˆé€‰æ‹©æ¨¡å‹');
                return;
            }

            const userMsg = document.createElement('div');
            userMsg.className = 'message user';
            userMsg.textContent = text;
            messages.appendChild(userMsg);
            input.value = '';
            messages.scrollTop = messages.scrollHeight;

            const config = JSON.parse(currentSelectedModel);
            const providers = ConfigManager.getProviders();
            const provider = providers[config.provider];

            const aiMsg = document.createElement('div');
            aiMsg.className = 'message ai';
            aiMsg.textContent = 'æ€è€ƒä¸­...';
            messages.appendChild(aiMsg);

            try {
                const finalUrl = normalizeApiUrl(provider.url);
                let fullContent = '';
                let buffer = '';
                let lastIndex = 0;

                // UI æ›´æ–°èŠ‚æµ
                let updateScheduled = false;
                const updateUI = () => {
                    if (updateScheduled) return;
                    updateScheduled = true;
                    requestAnimationFrame(() => {
                        safeInnerHTML(aiMsg, marked.parse(fullContent), fullContent);
                        aiMsg.querySelectorAll('pre code').forEach((block) => {
                            hljs.highlightElement(block);
                        });
                        messages.scrollTop = messages.scrollHeight;
                        updateScheduled = false;
                    });
                };

                const processStreamLine = (line) => {
                    const trimmedLine = line.trim();
                    if (!trimmedLine.startsWith('data:')) return;

                    const data = trimmedLine.slice(5).trim();
                    if (data === '[DONE]') return;

                    try {
                        const parsed = JSON.parse(data);
                        let delta = '';
                        if (parsed.choices && parsed.choices.length > 0) {
                            const choice = parsed.choices[0];
                            if (choice.delta && choice.delta.content) {
                                delta = choice.delta.content;
                            } else if (choice.message && choice.message.content) {
                                delta = choice.message.content;
                            } else if (choice.text) {
                                delta = choice.text;
                            }
                        } else if (parsed.content) {
                            delta = parsed.content;
                        }

                        if (delta) {
                            fullContent += delta;
                            updateUI();
                        }
                    } catch (e) {
                        // å¿½ç•¥è§£æé”™è¯¯
                    }
                };

                const requestData = {
                    model: config.model,
                    messages: currentSystemPrompt
                        ? [{role: 'system', content: currentSystemPrompt}, {role: 'user', content: text}]
                        : [{role: 'user', content: text}],
                    temperature: modelParams.temperature,
                    max_tokens: modelParams.max_tokens,
                    stream: true
                };

                // ä¼˜å…ˆå°è¯•ä½¿ç”¨ fetch (æ”¯æŒæµå¼)
                try {
                    aiMsg.textContent = '';
                    const response = await fetch(finalUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${provider.key}`
                        },
                        body: JSON.stringify(requestData)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        const chunk = decoder.decode(value, { stream: true });
                        buffer += chunk;
                        const lines = buffer.split('\n');
                        buffer = lines.pop();
                        lines.forEach(processStreamLine);
                    }

                    // å¤„ç†å‰©ä½™ buffer
                    if (buffer) processStreamLine(buffer);
                    updateUI();

                } catch (fetchError) {
                    console.warn('Fetch failed, falling back to GM_xmlhttpRequest:', fetchError);

                    // å¦‚æœ fetch å¤±è´¥ (å¯èƒ½æ˜¯ CORS)ï¼Œå›é€€åˆ° GM_xmlhttpRequest
                    // æ³¨æ„ï¼šGM_xmlhttpRequest åœ¨æŸäº›ç¯å¢ƒä¸‹å¯èƒ½ä¸æ”¯æŒæµå¼ï¼Œä¼šé€€åŒ–ä¸ºä¸€æ¬¡æ€§è¾“å‡º
                    GM_xmlhttpRequest({
                        method: 'POST',
                        url: finalUrl,
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${provider.key}`
                        },
                        data: JSON.stringify(requestData),
                        onloadstart: () => {
                            if (!fullContent) aiMsg.textContent = 'æ­£åœ¨é‡è¯•...';
                        },
                        onprogress: (response) => {
                            const responseText = response.responseText;
                            if (!responseText) return;

                            const newText = responseText.slice(lastIndex);
                            if (newText.length === 0) return;
                            lastIndex = responseText.length;
                            buffer += newText;

                            const lines = buffer.split('\n');
                            buffer = lines.pop();

                            lines.forEach(processStreamLine);
                        },
                        onload: (response) => {
                            if (buffer) processStreamLine(buffer);
                            updateUI();

                            if (!fullContent) {
                                // æœ€åçš„å…œåº•è§£æ
                                try {
                                    const data = JSON.parse(response.responseText);
                                    if (data.choices && data.choices[0]?.message?.content) {
                                        fullContent = data.choices[0].message.content;
                                        updateUI();
                                    } else if (data.error) {
                                        aiMsg.textContent = 'APIé”™è¯¯: ' + (data.error.message || JSON.stringify(data.error));
                                    }
                                } catch (e) {
                                    aiMsg.textContent = 'è¯·æ±‚å¤±è´¥: ' + (fetchError.message || 'æœªçŸ¥é”™è¯¯');
                                }
                            }
                        },
                        onerror: (err) => {
                            aiMsg.textContent = 'è¯·æ±‚å¤±è´¥: ' + (err.statusText || 'ç½‘ç»œé”™è¯¯');
                        }
                    });
                }
            } catch (e) {
                aiMsg.textContent = 'å‘é€å¤±è´¥: ' + e.message;
            }
        };

        sidebar.querySelector('#send-btn').addEventListener('click', sendMessage);
        sidebar.querySelector('#user-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // æç¤ºè¯åº“åŠŸèƒ½
        const renderPrompts = () => {
            const prompts = ConfigManager.getPrompts();
            const list = sidebar.querySelector('#prompts-list');
            list.textContent = '';

            prompts.forEach((prompt, index) => {
                const item = document.createElement('div');
                item.className = 'prompt-item';
                item.dataset.index = index;
                safeInnerHTML(item, `
                    <input type="checkbox" class="prompt-checkbox" data-index="${index}">
                    <div class="prompt-header">
                        <div class="prompt-title">${prompt.title || 'æœªå‘½å'}</div>
                        <div class="prompt-actions">
                            <button class="view-btn" data-index="${index}">æŸ¥çœ‹</button>
                            <button class="edit-btn" data-index="${index}">ç¼–è¾‘</button>
                            <button class="delete-btn" data-index="${index}">åˆ é™¤</button>
                        </div>
                    </div>
                    <div class="prompt-content" style="display:none;">${prompt.content || ''}</div>
                `);
                list.appendChild(item);
            });
        };

        sidebar.querySelector('#add-prompt').addEventListener('click', () => {
            const prompts = ConfigManager.getPrompts();
            prompts.push({title: '', content: ''});
            ConfigManager.savePrompts(prompts);
            renderPrompts();
            const items = sidebar.querySelectorAll('.prompt-item');
            const lastItem = items[items.length - 1];
            if (lastItem) {
                lastItem.querySelector('.edit-btn').click();
            }
        });

        sidebar.querySelector('#batch-delete-prompt').addEventListener('click', () => {
            const checkboxes = sidebar.querySelectorAll('.prompt-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('è¯·é€‰æ‹©è¦åˆ é™¤çš„æç¤ºè¯');
                return;
            }
            if (!confirm(`ç¡®å®šåˆ é™¤é€‰ä¸­çš„ ${checkboxes.length} ä¸ªæç¤ºè¯å—ï¼Ÿ`)) return;

            const prompts = ConfigManager.getPrompts();
            const indices = Array.from(checkboxes).map(cb => parseInt(cb.dataset.index)).sort((a, b) => b - a);
            indices.forEach(index => prompts.splice(index, 1));
            ConfigManager.savePrompts(prompts);
            renderPrompts();
        });

        sidebar.querySelector('#prompts-list').addEventListener('click', (e) => {
            const index = parseInt(e.target.dataset.index);
            const item = sidebar.querySelector(`.prompt-item[data-index="${index}"]`);

            if (e.target.classList.contains('view-btn')) {
                const content = item.querySelector('.prompt-content');
                content.style.display = content.style.display === 'none' ? 'block' : 'none';
            } else if (e.target.classList.contains('edit-btn')) {
                const prompts = ConfigManager.getPrompts();
                const prompt = prompts[index];
                item.classList.add('editing');
                safeInnerHTML(item, `
                    <div class="prompt-form">
                        <input type="text" placeholder="æ ‡é¢˜" value="${prompt.title || ''}" class="prompt-title-input">
                        <textarea placeholder="å†…å®¹" class="prompt-content-input">${prompt.content || ''}</textarea>
                        <div class="form-actions">
                            <button class="save-prompt-btn" data-index="${index}">ä¿å­˜</button>
                            <button class="cancel-btn" data-index="${index}">å–æ¶ˆ</button>
                        </div>
                    </div>
                `);
            } else if (e.target.classList.contains('delete-btn')) {
                if (!confirm('ç¡®å®šåˆ é™¤æ­¤æç¤ºè¯å—ï¼Ÿ')) return;
                const prompts = ConfigManager.getPrompts();
                prompts.splice(index, 1);
                ConfigManager.savePrompts(prompts);
                renderPrompts();
            } else if (e.target.classList.contains('save-prompt-btn')) {
                const prompts = ConfigManager.getPrompts();
                const titleInput = item.querySelector('.prompt-title-input');
                const contentInput = item.querySelector('.prompt-content-input');
                prompts[index] = {
                    title: titleInput.value.trim() || 'æœªå‘½å',
                    content: contentInput.value.trim()
                };
                ConfigManager.savePrompts(prompts);
                renderPrompts();
            } else if (e.target.classList.contains('cancel-btn')) {
                renderPrompts();
            }
        });

        renderPrompts();
    };

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
})();
